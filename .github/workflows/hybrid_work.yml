name: Aggiorna dati Hybrid

on:
  workflow_dispatch:
  schedule:
    # --- 8 ESECUZIONI AL GIORNO (Orari UTC) ---
    # Nota: L'Italia è UTC+1 (inverno) o UTC+2 (estate)
    
    # 1. Notte fonda / Apertura Asia (Esistente)
    - cron: '30 23 * * *'  
    
    # 2. Mattina presto (NUOVO - circa 05:00 IT)
    - cron: '0 4 * * *'    
    
    # 3. Apertura Europa (Esistente)
    #- cron: '30 6 * * *'   
    
    # 4. Metà mattina Europa (NUOVO - circa 11:00 IT)
    - cron: '0 10 * * *'    
    
    # 5. Pre-market USA / Pranzo (NUOVO - circa 13:30 IT)
    - cron: '30 12 * * *'   
    
    # 6. Apertura USA (Esistente)
    - cron: '0 14 * * *'   
    
    # 7. Chiusura Europa / Metà seduta USA (Esistente)
    #- cron: '30 16 * * *'  
    
    # 8. Chiusura USA (NUOVO - circa 21:30 IT)
    - cron: '30 20 * * *'   

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev

      - name: Upgrade pip, setuptools e wheel
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Install Python dependencies
        run: |
          # Librerie base e scientifiche
          pip install --no-cache-dir --upgrade numpy pandas scipy statsmodels

          # Librerie di rete e finanza
          pip install --no-cache-dir --upgrade yfinance==0.2.63 requests urllib3 feedparser lxml

          # Analisi dati, ML, NLP e NLTK (Aggiunto NLTK)
          pip install --no-cache-dir --upgrade ta \
            beautifulsoup4 scikit-learn xgboost PyGithub \
            torch transformers tiktoken blobfile argostranslate \
            nltk

          # spaCy aggiornato a una versione compatibile con Python 3.10
          pip install --no-cache-dir --prefer-binary spacy==3.7.2

      - name: Download NLP models (Spacy & NLTK)
        run: |
          # Scarica il modello Spacy (per compatibilità legacy)
          python -m spacy download en_core_web_sm-3.7.1
          
          # Scarica il lessico VADER per NLTK (per il nuovo Hybrid Score)
          python -m nltk.downloader vader_lexicon

      - name: Debug versions
        run: |
          python - <<'EOF'
          import yfinance, requests, urllib3, numpy, pandas, spacy, scipy, statsmodels, nltk
          print("yfinance =", yfinance.__version__)
          print("numpy =", numpy.__version__)
          print("pandas =", pandas.__version__)
          print("spacy =", spacy.__version__)
          print("nltk =", nltk.__version__)
          EOF

      - name: Run Hybrid Prediction Script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Esegue il nuovo script. Assicurati che il file sia nella cartella 'scripts'
        run: python scripts/predict_hybrid.py
